#!/bin/bash

VERSION="1.0.0"
BACKUP_DIR="$HOME/DevBackup-$(date +%Y%m%d-%H%M%S)"
BACKUP_FILE="$HOME/DevBackup.tar.gz"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

show_logo() {
    clear
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                          â•‘"
    echo "â•‘                       DEVBACKUP                          â•‘"
    echo "â•‘                       v$VERSION                             â•‘"
    echo "â•‘                                                          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo ""
}

log_info() { echo -e "${GREEN}âœ“${NC} $1"; }
log_warn() { echo -e "${YELLOW}âš ${NC} $1"; }
log_error() { echo -e "${RED}âœ—${NC} $1"; }
log_progress() { echo -e "${BLUE}â–¸${NC} $1"; }

detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ "$OSTYPE" == "win32" ]]; then
        echo "windows"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if grep -qi microsoft /proc/version 2>/dev/null; then
            echo "wsl"
        else
            echo "linux"
        fi
    else
        echo "unknown"
    fi
}

OS=$(detect_os)

show_menu() {
    show_logo
    echo -e "${CYAN}What would you like to do?${NC}"
    echo ""
    echo "  1) Backup this computer"
    echo "  2) Restore from backup"
    echo "  3) View backup info"
    echo "  4) Verify backup contents"
    echo "  5) Help"
    echo "  6) Exit"
    echo "  4) verify_backup ;;
        5) show_help"
    echo "  6) exit 0"
    echo ""
    read -p "Enter choice (1-6): " choice
    
    case $choice in
        1) backup_wizard ;;
        2) restore_wizard ;;
        3) show_backup_info ;;
        4) show_help ;;
        5) exit 0 ;;
        *) 
            log_error "Invalid choice"
            sleep 2
            show_menu
            ;;
    esac
}

backup_wizard() {
    show_logo
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘                    BACKUP WIZARD                         â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${GREEN}This will backup:${NC}"
    echo "  â€¢ All your applications"
    echo "  â€¢ Programming tools (Node, Python, etc.)"
    echo "  â€¢ IDEs (VS Code, Cursor, etc.)"
    echo "  â€¢ Shell configs"
    echo "  â€¢ SSH keys (public only)"
    echo ""
    read -p "Continue? (y/n): " confirm
    
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        show_menu
        return
    fi
    
    echo ""
    log_progress "Starting backup..."
    
    if create_backup; then
        show_logo
        echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${GREEN}â•‘                  âœ“ BACKUP COMPLETE!                      â•‘${NC}"
        echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -e "${CYAN}Your backup:${NC} ${YELLOW}$BACKUP_FILE${NC}"
        echo -e "${CYAN}Size:${NC} $(du -h "$BACKUP_FILE" 2>/dev/null | cut -f1)"
    else
        log_error "Backup failed"
    fi
    
    echo ""
    read -p "Press ENTER to return..."
    show_menu
}

create_backup() {
    mkdir -p "$BACKUP_DIR" || return 1
    
    echo "$OS" > "$BACKUP_DIR/source_os.txt"
    echo "$VERSION" > "$BACKUP_DIR/version.txt"
    
    log_progress "Backing up packages..."
    
    if command -v brew &> /dev/null; then
        brew bundle dump --file="$BACKUP_DIR/Brewfile" --force 2>/dev/null || true
    fi
    
    if command -v apt &> /dev/null; then
        dpkg --get-selections > "$BACKUP_DIR/apt-packages.txt" 2>/dev/null || true
    fi
    
    if command -v node &> /dev/null; then
        node --version > "$BACKUP_DIR/node-version.txt"
        npm list -g --depth=0 --json > "$BACKUP_DIR/npm-global.json" 2>/dev/null || true
    fi
    
    if command -v python3 &> /dev/null; then
        python3 --version > "$BACKUP_DIR/python-version.txt"
        pip3 list --format=freeze > "$BACKUP_DIR/pip3-packages.txt" 2>/dev/null || true
    fi
    
    log_progress "Backing up configs..."
    
    for file in .zshrc .bashrc .gitconfig .vimrc; do
        [ -f "$HOME/$file" ] && cp "$HOME/$file" "$BACKUP_DIR/" 2>/dev/null || true
    done
    
    if [ -d "$HOME/.ssh" ]; then
        mkdir -p "$BACKUP_DIR/.ssh"
        cp "$HOME/.ssh/config" "$BACKUP_DIR/.ssh/" 2>/dev/null || true
        find "$HOME/.ssh" -name "*.pub" -exec cp {} "$BACKUP_DIR/.ssh/" \; 2>/dev/null || true
    fi
    
    if command -v code &> /dev/null; then
        mkdir -p "$BACKUP_DIR/vscode"
        code --list-extensions > "$BACKUP_DIR/vscode/extensions.txt" 2>/dev/null || true
    fi
    
    log_progress "Creating archive..."
    
    tar -czf "$BACKUP_FILE" -C "$(dirname "$BACKUP_DIR")" "$(basename "$BACKUP_DIR")" 2>/dev/null || return 1
    rm -rf "$BACKUP_DIR"
    
    return 0
}

restore_wizard() {
    show_logo
    echo -e "${CYAN}Restore not implemented yet${NC}"
    echo ""
    read -p "Press ENTER to return..."
    show_menu
}

show_backup_info() {
    show_logo
    if [ -f "$BACKUP_FILE" ]; then
        echo -e "${GREEN}Latest backup:${NC}"
        echo -e "  ${YELLOW}$BACKUP_FILE${NC}"
        echo -e "  Size: $(du -h "$BACKUP_FILE" 2>/dev/null | cut -f1)"
    else
        echo -e "${YELLOW}No backup found${NC}"
    fi
    echo ""
    read -p "Press ENTER to return..."
    show_menu
}

show_help() {
    show_logo
    echo -e "${CYAN}Commands:${NC}"
    echo "  devbackup backup  - Create backup"
    echo "  devbackup restore - Restore backup"
    echo ""
    read -p "Press ENTER to return..."
    show_menu
}

main() {
    if [ "$1" == "backup" ]; then
        backup_wizard
    elif [ "$1" == "restore" ]; then
        restore_wizard
    elif [ "$1" == "help" ]; then
        show_help
    else
        show_menu
    fi
}

main "$@"

verify_backup() {
    show_logo
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘                  BACKUP VERIFICATION                     â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    if [ ! -f "$BACKUP_FILE" ]; then
        log_error "No backup found at $BACKUP_FILE"
        echo ""
        read -p "Press ENTER to return..."
        show_menu
        return
    fi
    
    log_progress "Analyzing backup..."
    
    mkdir -p /tmp/backup-verify
    tar -xzf "$BACKUP_FILE" -C /tmp/backup-verify 2>/dev/null
    
    VERIFY_DIR=$(find /tmp/backup-verify -maxdepth 1 -type d -name "DevBackup-*" | head -n 1)
    
    if [ -z "$VERIFY_DIR" ]; then
        log_error "Could not read backup"
        rm -rf /tmp/backup-verify
        read -p "Press ENTER to return..."
        show_menu
        return
    fi
    
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}ğŸ“¦ BACKUP SUMMARY${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    if [ -f "$VERIFY_DIR/source_os.txt" ]; then
        echo -e "${BLUE}OS:${NC} $(cat "$VERIFY_DIR/source_os.txt")"
    fi
    
    if [ -f "$VERIFY_DIR/node-version.txt" ]; then
        echo -e "${BLUE}Node:${NC} $(cat "$VERIFY_DIR/node-version.txt")"
    fi
    
    if [ -f "$VERIFY_DIR/python-version.txt" ]; then
        echo -e "${BLUE}Python:${NC} $(cat "$VERIFY_DIR/python-version.txt")"
    fi
    
    echo ""
    echo -e "${CYAN}ğŸ“‹ Packages Backed Up:${NC}"
    
    if [ -f "$VERIFY_DIR/npm-global.json" ]; then
        NPM_COUNT=$(grep -o '"version"' "$VERIFY_DIR/npm-global.json" | wc -l)
        echo -e "  ${GREEN}âœ“${NC} npm packages: $NPM_COUNT"
    fi
    
    if [ -f "$VERIFY_DIR/pip3-packages.txt" ]; then
        PIP_COUNT=$(wc -l < "$VERIFY_DIR/pip3-packages.txt")
        echo -e "  ${GREEN}âœ“${NC} pip packages: $PIP_COUNT"
    fi
    
    if [ -f "$VERIFY_DIR/apt-packages.txt" ]; then
        APT_COUNT=$(wc -l < "$VERIFY_DIR/apt-packages.txt")
        echo -e "  ${GREEN}âœ“${NC} apt packages: $APT_COUNT"
    fi
    
    echo ""
    echo -e "${CYAN}âš™ï¸  Configs Backed Up:${NC}"
    
    [ -f "$VERIFY_DIR/.zshrc" ] && echo -e "  ${GREEN}âœ“${NC} .zshrc"
    [ -f "$VERIFY_DIR/.bashrc" ] && echo -e "  ${GREEN}âœ“${NC} .bashrc"
    [ -f "$VERIFY_DIR/.gitconfig" ] && echo -e "  ${GREEN}âœ“${NC} .gitconfig"
    [ -f "$VERIFY_DIR/.vimrc" ] && echo -e "  ${GREEN}âœ“${NC} .vimrc"
    
    if [ -d "$VERIFY_DIR/.ssh" ]; then
        SSH_COUNT=$(ls "$VERIFY_DIR/.ssh" 2>/dev/null | wc -l)
        echo -e "  ${GREEN}âœ“${NC} SSH keys: $SSH_COUNT files"
    fi
    
    if [ -f "$VERIFY_DIR/vscode/extensions.txt" ]; then
        VSCODE_COUNT=$(wc -l < "$VERIFY_DIR/vscode/extensions.txt")
        echo -e "  ${GREEN}âœ“${NC} VS Code extensions: $VSCODE_COUNT"
    fi
    
    echo ""
    echo -e "${CYAN}ğŸ’¾ Backup Details:${NC}"
    echo -e "  File: ${YELLOW}$BACKUP_FILE${NC}"
    echo -e "  Size: $(du -h "$BACKUP_FILE" 2>/dev/null | cut -f1)"
    echo -e "  Date: $(stat -c %y "$BACKUP_FILE" 2>/dev/null | cut -d'.' -f1)"
    
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    
    rm -rf /tmp/backup-verify
    
    echo ""
    read -p "Press ENTER to return..."
    show_menu
}
